From 0e31bf94054c5baa3acffd857bd9e410603e5d34 Mon Sep 17 00:00:00 2001
From: KEGustafsson <ke.gustafsson@gmail.com>
Date: Fri, 11 Sep 2020 18:14:59 +0300
Subject: [PATCH] feature: loadAverage on Dashboard

---
 .../src/views/Dashboard/Dashboard.js               | 14 ++++++++++++--
 src/deltastats.js                                  |  8 ++++++--
 2 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/packages/server-admin-ui/src/views/Dashboard/Dashboard.js b/packages/server-admin-ui/src/views/Dashboard/Dashboard.js
index 7daba86..fdd9407 100644
--- a/packages/server-admin-ui/src/views/Dashboard/Dashboard.js
+++ b/packages/server-admin-ui/src/views/Dashboard/Dashboard.js
@@ -9,7 +9,10 @@ const Dashboard = props => {
     numberOfAvailablePaths,
     wsClients,
     providerStatistics,
-    uptime
+    uptime,
+    loadAvg1m,
+    loadAvg5m,
+    loadAvg15m
   } = props.serverStatistics || {
     deltaRate: 0,
     numberOfAvailablePaths: 0,
@@ -63,6 +66,13 @@ const Dashboard = props => {
                     <br />
                     <strong className='h5'>{uptimeD} days, {uptimeH} hours, {uptimeM} minutes</strong>
                   </div>
+                  <div className='callout callout-primary'>
+                    <small className='text-muted'>
+                      Average CPU Load (1/5/15min)
+                    </small>
+                    <br />
+                    <strong className='h5'>{loadAvg1m} {loadAvg5m} {loadAvg15m}</strong>
+                  </div>
                 </Col>
                 <Col xs='12' md='6'>
                   <div className='text-muted'>
@@ -144,7 +154,7 @@ const Dashboard = props => {
                  <td><p className={statusClass}>{(status.message || '').substring(0,80)}{status.message.length > 80 ? '...' : ''}</p></td>
                </tr>
                )
-               })}   
+               })}
                 </tbody>
               </Table>
               </Col>
diff --git a/src/deltastats.js b/src/deltastats.js
index 56c1d45..b9270f9 100644
--- a/src/deltastats.js
+++ b/src/deltastats.js
@@ -15,15 +15,16 @@
 */
 
 const { isUndefined, values } = require('lodash')
+const os = require('os')
 
 module.exports = {
   startDeltaStatistics: function(app) {
     app.deltaCount = 0
     app.lastIntervalDeltaCount = 0
     app.providerStatistics = {}
-
     return setInterval(() => {
       updateProviderPeriodStats(app)
+      const loadAverage = os.loadavg()
       app.emit('serverevent', {
         type: 'SERVERSTATISTICS',
         from: 'signalk-server',
@@ -32,7 +33,10 @@ module.exports = {
           numberOfAvailablePaths: app.streambundle.getAvailablePaths().length,
           wsClients: app.interfaces.ws ? app.interfaces.ws.numClients() : 0,
           providerStatistics: app.providerStatistics,
-          uptime: process.uptime()
+          uptime: process.uptime(),
+          loadAvg1m: loadAverage[0].toFixed(2),
+          loadAvg5m: loadAverage[1].toFixed(2),
+          loadAvg15m: loadAverage[2].toFixed(2)
         }
       })
       app.lastIntervalDeltaCount = app.deltaCount
-- 
2.25.1


